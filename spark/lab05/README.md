# Lab05. Подготовка матрицы признаков по логам, лежащим на HDFS, для модели машинного обучения

**Дедлайн**: 30 ноября, 23:59.

## I. Задача с высоты птичьего полета

У вас имеется матрица `users x items` для датасета visits (логи магазина). Теперь добавим к этим данным датасет weblogs (информация о посещениях веб-сайтов пользователями), знакомый вам по Лабе 3. Таким образом, соединив эти два датасета вместе по ключу `uid`, вы получите датасет для тренировки модели определения половозрастной категории пользователя по его покупкам, просмотрам товаров и посещениям веб-сайтов.

В следующей работе вы обучите модель и примените ее на потоковых данных.

![Alt text](../images/img5.png?raw=true "Архитектура")


## II. Конкретика

Возьмите датасет `weblogs` в `/mf-labs/laba02/`, выделите из url домены приведенным ниже способом. Из этих доменов сделайте матрицу типа `users x items`. Для каждого юзера в колонке `domain_features` должен содержаться вектор с числами посещений каждого сайта из топ-1000 по посещениям или 0, если не посещал.
> Для получение вектора самых посещаемых доменов необходимо взять 1000 самых посещяемых доменов (без привязки к пользователю), затем отсортировать их по алфавиту. 
> Домен null не учитывается, все остальные домены учитываются в том виде, который получился из parse_url и удаления "www.". 
> Дополнительно чистить и переименовывать домены не нужно, иначе собьется порядок.

Из временных меток посещения сайтов сделайте следующие признаки (колонки):

* число посещений по дням недели. То есть, постройте 7 признаков - "web_day_mon", "web_day_tue", ... , "web_day_sun" и прибавьте 1 для каждой метки, которая попадает на тот или иной день недели.
* число посещений по часам в сутках. Аналогично дням недели: "web_hour_0", ... "web_hour_23".
* долю посещений в рабочие часы "web_fraction_work_hours" (число посещений в рабочие часы/общее число посещений данного клиента) и долю посещений в вечерние часы "web_fraction_evening_hours", где рабочие часы - [9, 18), а вечерние - [18, 24).

Предупреждения и подсказки:

* в этом датасете в каждой строчке уникальный пользователь, повторений нет.
* посещения - число записей в поле visits. Если у одного пользователя встречается тот же url и та же временная метка два раза - все равно это два посещения.
* :warning: Внимание, часы считаются во временной зоне UTC
> Скорее всего, потребуется обращаться к колонкам, не зная их наименования. 
> У Спарка не работает функция col() на названия колонок с точкой внутри. 
> Чтобы обратиться к колонке с точкой можно использовать символ "`". Пример: col("`" + colName + "`".

### Как сделать domain features

#### Экстракция URL:

```
.withColumn("host", lower(callUDF("parse_url", $"visit.url", lit("HOST"))))
                        .withColumn("domain", regexp_replace($"host", "www.", ""))
```

#### Реализация

Вариант "попроще" - возпользоваться pivot, потом собрать вектор в отдельную колонку.

Вариант "посложнее" - реализуйте облегченный вариант CountVectorizer из пакета Spark ML.

В любом случае, ваш выходной вектор (частоты посещений) должен быть упорядочен в алфавитном порядке соответствующих доменов, так как чекер будет проверять число посещений по вполне конктретным индексам.

Слейте этот датасет с матрицей `users-items` из лабы 04 (версия 20200429, которая должна храниться у вас в домашней директории HDFS в подпапке visits) по ключу `uid`, чтобы получился один большой датасет.

Сохраните в формате parquet по пути `/user/name.surname/features`.


## III. Оформление работы

В вашем репо в подпапке `lab05` положите `features.py`.

Проект должен запускаться следующим образом:

```
cd lab05
spark-submit features.py 
```
Не забывайте о правильно заполненном .gitignore в корне репозитория. 

## IV. Проверка

Чекер считает матрицу `features` и проверит её выборочно для какого-то пользователя. Запуск вашего проекта производится не будет.

### Поля чекера

* git_correct - True/False присутствует файл features.scala
* info_git_errors - ошибки проверки репозитория 

* domain_features1_correct - True/False - проверка колонки с вектором domain_features
* info_domain_features1_your_data = "",
* info_domain_features1_errors = "",

* time_features1_correct - True/False - проверка признаков, основанных на временных метках.
* info_time_features1_your_data = "",
* info_time_features1_errors = "",

* item_features1_correct = True/False, - проверка признаков, основанных на покупках или просмотрах в магазине
* info_item_features1_your_data = "",
* info_item_features1_errors = "",

* info_your_data - остальные ваши данные
* info_errors - оостальные ошибки, если есть
* lab_result - True/False
